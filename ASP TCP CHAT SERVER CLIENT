import asyncio
import sys

clients = {}

async def handle_client(reader, writer):
    addr = writer.get_extra_info('peername')
    writer.write(b"Enter your username:\n")
    await writer.drain()
    username = (await reader.readline()).decode().strip() or f"user_{addr[1]}"
    clients[username] = writer
    await broadcast(f"[JOIN] {username}\n", exclude=username)
    try:
        writer.write(f"Hello {username}! Type messages, or /quit.\n".encode())
        await writer.drain()
        while True:
            data = await reader.readline()
            if not data:
                break
            msg = data.decode().strip()
            if msg.lower() == "/quit":
                break
            elif msg.startswith("/pm "):
                parts = msg.split(" ", 2)
                if len(parts) >= 3:
                    to_user, pm = parts[1], parts[2]
                    w = clients.get(to_user)
                    if w:
                        w.write(f"[PM] {username}: {pm}\n".encode())
                        await w.drain()
                        writer.write(f"[PM sent to {to_user}] {pm}\n".encode())
                        await writer.drain()
                    else:
                        writer.write(f"User {to_user} not found.\n".encode())
                        await writer.drain()
                else:
                    writer.write(b"Usage: /pm <user> <message>\n")
                    await writer.drain()
            else:
                await broadcast(f"{username}: {msg}\n", exclude=None)
    finally:
        await broadcast(f"[LEAVE] {username}\n", exclude=username)
        clients.pop(username, None)
        writer.close()
        await writer.wait_closed()

async def broadcast(message, exclude=None):
    for user, w in list(clients.items()):
        if exclude and user == exclude:
            continue
        try:
            w.write(message.encode())
            await w.drain()
        except Exception:
            pass

async def run_server(port):
    server = await asyncio.start_server(handle_client, '0.0.0.0', port)
    addrs = ", ".join(str(s.getsockname()) for s in server.sockets)
    print(f"Server listening on {addrs}")
    async with server:
        await server.serve_forever()

async def run_client(host, port, username):
    reader, writer = await asyncio.open_connection(host, port)
    # read prompt
    print((await reader.readline()).decode().rstrip())
    writer.write((username + "\n").encode())
    await writer.drain()
    print((await reader.readline()).decode().rstrip())
    async def read_loop():
        while True:
            data = await reader.readline()
            if not data:
                break
            print(data.decode().rstrip())
    asyncio.create_task(read_loop())
    loop = asyncio.get_event_loop()
    while True:
        msg = await loop.run_in_executor(None, sys.stdin.readline)
        if not msg:
            break
        writer.write(msg.encode())
        await writer.drain()
        if msg.strip().lower() == "/quit":
            break
    writer.close()
    await writer.wait_closed()

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage:\n  Server: python chat.py server <port>\n  Client: python chat.py client <host> <port> <username>")
        sys.exit(1)
    mode = sys.argv[1].lower()
    if mode == "server":
        port = int(sys.argv[2])
        asyncio.run(run_server(port))
    elif mode == "client":
        host, port, user = sys.argv[2], int(sys.argv[3]), sys.argv[4]
        asyncio.run(run_client(host, port, user))
    else:
        print("Unknown mode")
